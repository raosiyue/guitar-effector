#include "wm8978.h"
#include "myiic.h"

//////////////////////////////////////////////////////////////////////////////////	 
//?????????,??????,??????????
//YTCE STM32F407???
//WM8978 ????	   
//????@YTCE
//http://s8088.taobao.com
 								  
////////////////////////////////////////////////////////////////////////////////// 	

//WM8978???????(??58????,0~57),??116????de
//??WM8978?IIC????????,?????????????
//?WM8978????,???????????,?????,?????????????.
//??:WM8978??????9??,????uint16_t???. 
static uint16_t WM8978_REGVAL_TBL[58]=
{
	0X0000,0X0000,0X0000,0X0000,0X0050,0X0000,0X0140,0X0000,
	0X0000,0X0000,0X0000,0X00FF,0X00FF,0X0000,0X0100,0X00FF,
	0X00FF,0X0000,0X012C,0X002C,0X002C,0X002C,0X002C,0X0000,
	0X0032,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,0X0000,
	0X0038,0X000B,0X0032,0X0000,0X0008,0X000C,0X0093,0X00E9,
	0X0000,0X0000,0X0000,0X0000,0X0003,0X0010,0X0010,0X0100,
	0X0100,0X0002,0X0001,0X0001,0X0039,0X0039,0X0039,0X0039,
	0X0001,0X0001
}; 
//WM8978???
//???:0,?????
//    ??,????
uint8_t WM8978_Init(void)
{
	uint8_t res;
	IIC_Init();//???IIC??
	res=WM8978_Write_Reg(0,0);	//???WM8978
	if(res)return 1;			//??????,WM8978??
	//???????
	WM8978_Write_Reg(1,0XDB );	//R1,MICEN???1(MIC??),BIASEN???1(?????),VMIDSEL[1:0]???:11(5K)
	WM8978_Write_Reg(2,0X1B0);	//R2,ROUT1,LOUT1????(??????),BOOSTENR,BOOSTENL??
	WM8978_Write_Reg(3,0X1EC);	//R3,LOUT2,ROUT2????(????),RMIX,LMIX??	
	WM8978_Write_Reg(6,0);		//R6,MCLK?????
	//WM8978_Write_Reg(8,0x4);		//R6,MCLK?????
	WM8978_Write_Reg(43,1<<4);	//R43,INVROUT2??,????
	WM8978_Write_Reg(47,1<<8);	//R47??,PGABOOSTL,???MIC??20???
	WM8978_Write_Reg(48,1<<8);	//R48??,PGABOOSTR,???MIC??20???
	WM8978_Write_Reg(49,1<<1);	//R49,TSDEN,?????? 
	WM8978_Write_Reg(10,1<<3);	//R10,SOFTMUTE??,128x??,??SNR 
	WM8978_Write_Reg(14,1<<3);	//R14,ADC 128x???
	WM8978_Write_Reg(56,0X01);	//OUT3,???	
	WM8978_Write_Reg(57,0X01);	//OUT4,???
	return 0;
} 
//WM8978????
//reg:?????
//val:???????? 
//???:0,??;
//    ??,????
uint8_t WM8978_Write_Reg(uint8_t reg,uint16_t val)
{ 
	IIC_Start(); 
	IIC_Send_Byte((WM8978_ADDR<<1)|0);//??????+???	 
	if(IIC_Wait_Ack())return 1;	//????(???/???) 
    IIC_Send_Byte((reg<<1)|((val>>8)&0X01));//??????+??????
	if(IIC_Wait_Ack())return 2;	//????(???/???) 
	IIC_Send_Byte(val&0XFF);	//????
	if(IIC_Wait_Ack())return 3;	//????(???/???) 
    IIC_Stop();
	WM8978_REGVAL_TBL[reg]=val;	//?????????
	return 0;	
}  
//WM8978????
//??????????????????
//reg:????? 
//???:????
uint16_t WM8978_Read_Reg(uint8_t reg)
{  
	return WM8978_REGVAL_TBL[reg];	
} 
//WM8978 DAC/ADC??
//adcen:adc??(1)/??(0)
//dacen:dac??(1)/??(0)
void WM8978_ADDA_Cfg(uint8_t dacen,uint8_t adcen)
{
	uint16_t regval;
	regval=WM8978_Read_Reg(3);	//??R3
	if(dacen)regval|=3<<0;		//R3??2?????1,??DACR&DACL
	else regval&=~(3<<0);		//R3??2????,??DACR&DACL.
	WM8978_Write_Reg(3,regval);	//??R3
	regval=WM8978_Read_Reg(2);	//??R2
	if(adcen)regval|=3<<0;		//R2??2?????1,??ADCR&ADCL
	else regval&=~(3<<0);		//R2??2????,??ADCR&ADCL.
	WM8978_Write_Reg(2,regval);	//??R2	
}
//WM8978 ?????? 
//micen:MIC??(1)/??(0)
//lineinen:Line In??(1)/??(0)
//auxen:aux??(1)/??(0) 
void WM8978_Input_Cfg(uint8_t micen,uint8_t lineinen,uint8_t auxen)
{
	uint16_t regval;  
	regval=WM8978_Read_Reg(2);	//??R2
	if(micen)regval|=3<<2;		//??INPPGAENR,INPPGAENL(MIC?PGA??)
	else regval&=~(3<<2);		//??INPPGAENR,INPPGAENL.
 	WM8978_Write_Reg(2,regval);	//??R2 
	
	regval=WM8978_Read_Reg(44);	//??R44
	if(micen)regval|=3<<4|3<<0;	//??LIN2INPPGA,LIP2INPGA,RIN2INPPGA,RIP2INPGA.
	else regval&=~(3<<4|3<<0);	//??LIN2INPPGA,LIP2INPGA,RIN2INPPGA,RIP2INPGA.
	WM8978_Write_Reg(44,regval);//??R44
	
	if(lineinen)WM8978_LINEIN_Gain(7);//LINE IN 0dB??
	else WM8978_LINEIN_Gain(0);	//??LINE IN
	if(auxen)WM8978_AUX_Gain(7);//AUX 6dB??
	else WM8978_AUX_Gain(0);	//??AUX??  
}
//WM8978 ???? 
//dacen:DAC??(??)??(1)/??(0)
//bpsen:Bypass??(??,??MIC,LINE IN,AUX?)??(1)/??(0) 
void WM8978_Output_Cfg(uint8_t dacen,uint8_t bpsen)
{
	uint16_t regval=0;
	if(dacen)regval|=1<<0;	//DAC????
	if(bpsen)
	{
		regval|=1<<1;		//BYPASS??
		regval|=5<<2;		//0dB??
	} 
	WM8978_Write_Reg(50,regval);//R50??
	WM8978_Write_Reg(51,regval);//R51?? 
}
//WM8978 MIC????(???BOOST?20dB,MIC-->ADC???????)
//gain:0~63,??-12dB~35.25dB,0.75dB/Step
void WM8978_MIC_Gain(uint8_t gain)
{
	gain&=0X3F;
	WM8978_Write_Reg(45,gain);		//R45,???PGA?? 
	WM8978_Write_Reg(46,gain|1<<8);	//R46,???PGA??
}
//WM8978 L2/R2(???Line In)????(L2/R2-->ADC???????)
//gain:0~7,0??????,1~7,??-12dB~6dB,3dB/Step
void WM8978_LINEIN_Gain(uint8_t gain)
{
	uint16_t regval;
	gain&=0X07;
	regval=WM8978_Read_Reg(47);	//??R47
	regval&=~(7<<4);			//??????? 
 	WM8978_Write_Reg(47,regval|gain<<4);//??R47
	regval=WM8978_Read_Reg(48);	//??R48
	regval&=~(7<<4);			//??????? 
 	WM8978_Write_Reg(48,regval|gain<<4);//??R48
} 
//WM8978 AUXR,AUXL(PWM????)????(AUXR/L-->ADC???????)
//gain:0~7,0??????,1~7,??-12dB~6dB,3dB/Step
void WM8978_AUX_Gain(uint8_t gain)
{
	uint16_t regval;
	gain&=0X07;
	regval=WM8978_Read_Reg(47);	//??R47
	regval&=~(7<<0);			//??????? 
 	WM8978_Write_Reg(47,regval|gain<<0);//??R47
	regval=WM8978_Read_Reg(48);	//??R48
	regval&=~(7<<0);			//??????? 
 	WM8978_Write_Reg(48,regval|gain<<0);//??R48
}  
//??I2S????
//fmt:0,LSB(???);1,MSB(???);2,?????I2S;3,PCM/DSP;
//len:0,16?;1,20?;2,24?;3,32?;  
void WM8978_I2S_Cfg(uint8_t fmt,uint8_t len)
{
	fmt&=0X03;
	len&=0X03;//????
	WM8978_Write_Reg(4,(fmt<<3)|(len<<5));	//R4,WM8978??????	
}	

//??????????
//voll:?????(0~63)
//volr:?????(0~63)
void WM8978_HPvol_Set(uint8_t voll,uint8_t volr)
{
	voll&=0X3F;
	volr&=0X3F;//????
	if(voll==0)voll|=1<<6;//???0?,??mute
	if(volr==0)volr|=1<<6;//???0?,??mute 
	WM8978_Write_Reg(52,voll);			//R52,?????????
	WM8978_Write_Reg(53,volr|(1<<8));	//R53,?????????,????(HPVU=1)
}
//??????
//voll:?????(0~63) 
void WM8978_SPKvol_Set(uint8_t volx)
{ 
	volx&=0X3F;//????
	if(volx==0)volx|=1<<6;//???0?,??mute 
 	WM8978_Write_Reg(54,volx);			//R54,?????????
	WM8978_Write_Reg(55,volx|(1<<8));	//R55,?????????,????(SPKVU=1)	
}
//??3D???
//depth:0~15(3D??,0??,15??)
void WM8978_3D_Set(uint8_t depth)
{ 
	depth&=0XF;//???? 
 	WM8978_Write_Reg(41,depth);	//R41,3D???? 	
}
//??EQ/3D????
//dir:0,?ADC???
//    1,?DAC???(??)
void WM8978_EQ_3D_Dir(uint8_t dir)
{
	uint16_t regval; 
	regval=WM8978_Read_Reg(0X12);
	if(dir)regval|=1<<8;
	else regval&=~(1<<8); 
 	WM8978_Write_Reg(18,regval);//R18,EQ1??9???EQ/3D??
}

//??EQ1
//cfreq:????,0~3,????:80/105/135/175Hz
//gain:??,0~24,??-12~+12dB
void WM8978_EQ1_Set(uint8_t cfreq,uint8_t gain)
{ 
	uint16_t regval;
	cfreq&=0X3;//???? 
	if(gain>24)gain=24;
	gain=24-gain;
	regval=WM8978_Read_Reg(18);
	regval&=0X100;
	regval|=cfreq<<5;	//?????? 
	regval|=gain;		//????	
 	WM8978_Write_Reg(18,regval);//R18,EQ1?? 	
}
//??EQ2
//cfreq:????,0~3,????:230/300/385/500Hz
//gain:??,0~24,??-12~+12dB
void WM8978_EQ2_Set(uint8_t cfreq,uint8_t gain)
{ 
	uint16_t regval=0;
	cfreq&=0X3;//???? 
	if(gain>24)gain=24;
	gain=24-gain; 
	regval|=cfreq<<5;	//?????? 
	regval|=gain;		//????	
 	WM8978_Write_Reg(19,regval);//R19,EQ2?? 	
}
//??EQ3
//cfreq:????,0~3,????:650/850/1100/1400Hz
//gain:??,0~24,??-12~+12dB
void WM8978_EQ3_Set(uint8_t cfreq,uint8_t gain)
{ 
	uint16_t regval=0;
	cfreq&=0X3;//???? 
	if(gain>24)gain=24;
	gain=24-gain; 
	regval|=cfreq<<5;	//?????? 
	regval|=gain;		//????	
 	WM8978_Write_Reg(20,regval);//R20,EQ3?? 	
}
//??EQ4
//cfreq:????,0~3,????:1800/2400/3200/4100Hz
//gain:??,0~24,??-12~+12dB
void WM8978_EQ4_Set(uint8_t cfreq,uint8_t gain)
{ 
	uint16_t regval=0;
	cfreq&=0X3;//???? 
	if(gain>24)gain=24;
	gain=24-gain; 
	regval|=cfreq<<5;	//?????? 
	regval|=gain;		//????	
 	WM8978_Write_Reg(21,regval);//R21,EQ4?? 	
}
//??EQ5
//cfreq:????,0~3,????:5300/6900/9000/11700Hz
//gain:??,0~24,??-12~+12dB
void WM8978_EQ5_Set(uint8_t cfreq,uint8_t gain)
{ 
	uint16_t regval=0;
	cfreq&=0X3;//???? 
	if(gain>24)gain=24;
	gain=24-gain; 
	regval|=cfreq<<5;	//?????? 
	regval|=gain;		//????	
 	WM8978_Write_Reg(22,regval);//R22,EQ5?? 	
}